name: Build FFmpeg AAR (Modified Script)
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout FFmpegKit
        run: |
          git clone --depth=1 https://github.com/arthenica/ffmpeg-kit.git
          cd ffmpeg-kit
          git submodule update --init --recursive
      
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y autoconf automake build-essential pkg-config \
            cmake yasm nasm python3 python3-pip unzip git wget texinfo \
            libtool libssl-dev zlib1g-dev
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download and Setup Android NDK
        run: |
          cd $HOME
          wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          echo "ANDROID_NDK_ROOT=$HOME/android-ndk-r25c" >> $GITHUB_ENV
      
      - name: Accept GPL License
        run: |
          echo "LICENSE_ACCEPTED=1" >> $GITHUB_ENV
          echo "ANDROID_GPL_ENABLED=1" >> $GITHUB_ENV
      
      - name: Modify build script for arm64-v8a only
        run: |
          cd ffmpeg-kit
          cp android.sh android-arm64.sh
          # Force only arm64-v8a architecture
          sed -i 's/ANDROID_ARCHS=.*/ANDROID_ARCHS=("arm64-v8a")/' android-arm64.sh
          # Make it executable
          chmod +x android-arm64.sh
      
      - name: Build FFmpegKit (GPL + arm64-v8a only)
        run: |
          cd ffmpeg-kit
          ./android-arm64.sh --enable-gpl --lts
      
      - name: List built files
        run: |
          find ffmpeg-kit/prebuilt -name "*arm64*" -type f -ls
      
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-gpl-lts-arm64-v8a-modified
          path: |
            ffmpeg-kit/prebuilt/bundle-android-aar/*arm64*.aar
            ffmpeg-kit/prebuilt/android-aar/*arm64*.aar
          if-no-files-found: warn
